{% extends 'game/includes/base.html' %}
{% block head_title %}ê²Œì„ ë¡œë¹„{% endblock %}
{% block page_title %}ê²Œì„ ë¡œë¹„{% endblock %}


{% block content %} 
    {% include 'game/includes/info.html' with player_nickname=player_nickname game_session=game_session %}

    <table id="player-list">
        <thead><b>í˜„ì¬ ì°¸ì—¬ ì¤‘ì¸ í”Œë ˆì´ì–´</b></thead>
        <tbody><tr><td colspan="2">í”Œë ˆì´ì–´ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr></tbody>
    </table >

    <label for="session-link">ğŸ”—:</label>
    <input type="text" id="session-link" value="{{ session_link }}" readonly style="width: 100px;">
    <button onclick="copySessionLink()">ë³µì‚¬</button>
    <p id="copy-message" style="color: green;"></p>

    {% if player_nickname == game_session.host_nickname %}
        <form method="post" action="{% url 'start_game' game_session.session_id %}">
            {% csrf_token %}
            <input type="hidden" name="nickname" value="{{ player_nickname }}">
            <input type="hidden" name="pin" value="{{ player_pin }}">
            <button type="submit" class="start-game-button" onclick="return confirm('ì •ë§ë¡œ ê²Œì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ê²Œì„ ì‹œì‘</button>
        </form>
    {% endif %}

{% endblock %}


{% block extra_body %}
    <!-- ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸ -->
    <meta name="csrf-token" content="{{ csrf_token }}">
    <script>
    let lastHash = null;
    const playerNickname = "{{ player_nickname }}";
    const playerPin = "{{ player_pin }}";
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    function updatePlayerList() {
        const url = new URL("{% url 'get_state' game_session.session_id %}", window.location.origin);
        if (lastHash) {
            url.searchParams.append('hash', lastHash)
        };

        fetch(url)
            .then(response => {
                if (response.status === 204) { 
                    return; // ë³€ê²½ ì—†ìŒ, ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
                }
                return response.json();
            })
            .then(data => {
                if (!data || !data.players) {
                    return;
                }

                if (data.is_active === false) {
                    window.location.href = "{% url 'ended' game_session.session_id %}";
                    return;
                }

                if (data.is_started === true) {
                    window.location.href = "{% url 'role' game_session.session_id %}?nickname=" + playerNickname + "&pin=" + playerPin;
                    return;
                }
                
                const tableBody = document.getElementById("player-list");
                tableBody.innerHTML = '';

                data.players.forEach(function(nickname) {
                    let kickBtn = '';
                    if (playerNickname === data.host_nickname && nickname !== playerNickname) {
                        kickBtn = `
                            <form method="post" action="{% url 'kick_player' game_session.session_id %}">
                                <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                                <input type="hidden" name="target_nickname" value="${nickname}">
                                <input type="hidden" name="nickname" value="${playerNickname}">
                                <input type="hidden" name="pin" value="${playerPin}">
                                <button type="submit">âŒ</button>
                            </form>
                        `;
                    }
                    const rowContent = `<td>${kickBtn}</td><td>${nickname}</td>`;
                    const row = document.createElement("tr");
                    row.innerHTML = rowContent;
                    tableBody.appendChild(row);
                });
                lastHash = data.hash;
            })
            .catch(err => console.error("í”Œë ˆì´ì–´ ëª©ë¡ ê°±ì‹  ì‹¤íŒ¨:", err));
    }

    setInterval(updatePlayerList, 1000); // ms
    </script>

    <!-- ë§í¬ ë³µì‚¬ -->
    <script>
    function copySessionLink() {
        const input = document.getElementById("session-link");
        input.select();
        input.setSelectionRange(0, 99999); // ëª¨ë°”ì¼ ëŒ€ì‘

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                document.getElementById("copy-message").textContent = "í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!";
            } else {
                document.getElementById("copy-message").textContent = "ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
            }
        } catch (err) {
            document.getElementById("copy-message").textContent = "ì´ ë¸Œë¼ìš°ì €ëŠ” ë³µì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
        }

        setTimeout(() => {
            document.getElementById("copy-message").textContent = "";
        }, 2000);
    }
    </script>
{% endblock %}