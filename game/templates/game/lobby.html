{% extends 'game/includes/base.html' %}
{% block head_title %}ê²Œì„ ë¡œë¹„{% endblock %}
{% block page_title %}ê²Œì„ ë¡œë¹„{% endblock %}

{% block content %} 
    <div class="lobby-container">
        <!-- ê²Œì„ ì •ë³´ ì¹´ë“œ -->
        <div class="game-info-card">
            <div class="info-header">
                <div class="info-icon">ğŸ°</div>
                <h3 class="info-title">ê²Œì„ ì •ë³´</h3>
            </div>
            
            <div class="info-content">
                <div class="info-item">
                    <span class="info-label">ì„¸ì…˜ ID</span>
                    <span class="info-value session-id">{{ game_session.session_id }}</span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">ê²Œì„ ì˜µì…˜</span>
                    <div class="info-options">
                        {% if game_session.option1 and game_session.option2 %}
                                                         <span class="option-badge percival">ğŸ›¡ï¸ í¼ì‹œë²Œ</span>
                             <span class="option-badge morgana">ğŸ¦¹â€â™€ï¸ ëª¨ë¥´ê°€ë‚˜</span>
                         {% elif game_session.option1 %}
                             <span class="option-badge percival">ğŸ›¡ï¸ í¼ì‹œë²Œ</span>
                         {% elif game_session.option2 %}
                             <span class="option-badge morgana">ğŸ¦¹â€â™€ï¸ ëª¨ë¥´ê°€ë‚˜</span>
                        {% else %}
                            <span class="option-badge none">ğŸ¯ ê¸°ë³¸ ê²Œì„</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="info-item">
                    <span class="info-label">í˜„ì¬ í”Œë ˆì´ì–´</span>
                    <span class="info-value player-name">{{ player_nickname }}</span>
                </div>
            </div>
        </div>

        <!-- í”Œë ˆì´ì–´ ëª©ë¡ ì¹´ë“œ -->
        <div class="players-card">
            <div class="players-header">
                <div class="players-icon">ğŸ‘¥</div>
                <h3 class="players-title">ì°¸ì—¬ ì¤‘ì¸ í”Œë ˆì´ì–´</h3>
                <div class="players-count" id="players-count">0ëª…</div>
            </div>
            
            <div class="players-content">
                <div id="player-list" class="player-list">
                    <div class="loading-placeholder">
                        <div class="loading-spinner"></div>
                        <span>í”Œë ˆì´ì–´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì„¸ì…˜ ë§í¬ ê³µìœ  ì¹´ë“œ -->
        <div class="share-card">
            <div class="share-header">
                <div class="share-icon">ğŸ”—</div>
                <h3 class="share-title">ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸°</h3>
            </div>
            
            <div class="share-content">
                <div class="link-input-group">
                    <input type="text" id="session-link" value="{{ session_link }}" readonly class="share-input">
                    <button onclick="copySessionLink()" class="copy-btn">
                        <span class="copy-btn-icon">ğŸ“‹</span>
                        <span class="copy-btn-text">ë³µì‚¬</span>
                    </button>
                </div>
                <div id="copy-message" class="copy-message"></div>
            </div>
        </div>

        <!-- ê²Œì„ ì‹œì‘ ì¹´ë“œ (í˜¸ìŠ¤íŠ¸ë§Œ ë³´ì„) -->
        {% if player_nickname == game_session.host_nickname %}
        <div class="host-actions-card">
            <div class="host-header">
                <div class="host-icon">ğŸ‘‘</div>
                <h3 class="host-title">ê²Œì„ ì‹œì‘</h3>
                <div class="host-badge">í˜¸ìŠ¤íŠ¸</div>
            </div>
            
            <div class="host-content">
                <p class="start-description">ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ë˜ë©´ ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”!</p>
                <form method="post" action="{% url 'start_game' game_session.session_id %}">
                    {% csrf_token %}
                    <input type="hidden" name="nickname" value="{{ player_nickname }}">
                    <input type="hidden" name="pin" value="{{ player_pin }}">
                    <button type="submit" class="start-game-btn" onclick="return confirm('ì •ë§ë¡œ ê²Œì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        <span class="btn-icon">ğŸš€</span>
                        <span class="btn-text">ê²Œì„ ì‹œì‘</span>
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- ëŒ€ê¸° ì¤‘ ë©”ì‹œì§€ (í˜¸ìŠ¤íŠ¸ê°€ ì•„ë‹Œ ê²½ìš°) -->
        {% if player_nickname != game_session.host_nickname %}
        <div class="waiting-card">
            <div class="waiting-content">
                <div class="waiting-icon">â³</div>
                <h3 class="waiting-title">ê²Œì„ ì‹œì‘ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</h3>
                <p class="waiting-description">í˜¸ìŠ¤íŠ¸ê°€ ê²Œì„ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
            </div>
        </div>
        {% endif %}
    </div>
{% endblock %}

{% block extra_body %}
    <!-- ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸ -->
    <meta name="csrf-token" content="{{ csrf_token }}">
    <script>
    let lastHash = null;
    const playerNickname = "{{ player_nickname }}";
    const playerPin = "{{ player_pin }}";
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    
    function updatePlayerList() {
        const url = new URL("{% url 'get_state' game_session.session_id %}", window.location.origin);
        if (lastHash) {
            url.searchParams.append('hash', lastHash)
        };

        fetch(url)
            .then(response => {
                if (response.status === 204) { 
                    return; // ë³€ê²½ ì—†ìŒ, ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
                }
                return response.json();
            })
            .then(data => {
                if (!data || !data.players) {
                    return;
                }

                if (data.is_active === false) {
                    window.location.href = "{% url 'ended' game_session.session_id %}";
                    return;
                }

                if (data.is_started === true) {
                    window.location.href = "{% url 'role' game_session.session_id %}?nickname=" + playerNickname + "&pin=" + playerPin;
                    return;
                }
                
                const playerListContainer = document.getElementById("player-list");
                const playersCount = document.getElementById("players-count");
                
                // í”Œë ˆì´ì–´ ìˆ˜ ì—…ë°ì´íŠ¸
                playersCount.textContent = data.players.length + 'ëª…';
                
                // í”Œë ˆì´ì–´ ëª©ë¡ ì´ˆê¸°í™”
                playerListContainer.innerHTML = '';

                data.players.forEach(function(nickname) {
                    const playerItem = document.createElement("div");
                    playerItem.className = "player-item";
                    
                    const isHost = nickname === data.host_nickname;
                    const canKick = playerNickname === data.host_nickname && nickname !== playerNickname;
                    
                    let kickButton = '';
                    if (canKick) {
                        kickButton = `
                            <form method="post" action="{% url 'kick_player' game_session.session_id %}" class="kick-form">
                                <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                                <input type="hidden" name="target_nickname" value="${nickname}">
                                <input type="hidden" name="nickname" value="${playerNickname}">
                                <input type="hidden" name="pin" value="${playerPin}">
                                <button type="submit" class="kick-btn" title="í”Œë ˆì´ì–´ ì¶”ë°©">
                                    <span class="kick-icon">âŒ</span>
                                </button>
                            </form>
                        `;
                    }
                    
                    const hostBadge = isHost ? '<span class="player-host-badge">ğŸ‘‘</span>' : '';
                    
                    playerItem.innerHTML = `
                        <div class="player-info">
                            <div class="player-avatar">ğŸ‘¤</div>
                            <div class="player-details">
                                <span class="player-nickname">${nickname}</span>
                                ${hostBadge}
                            </div>
                        </div>
                        ${kickButton}
                    `;
                    
                    playerListContainer.appendChild(playerItem);
                });
                
                lastHash = data.hash;
            })
            .catch(err => console.error("í”Œë ˆì´ì–´ ëª©ë¡ ê°±ì‹  ì‹¤íŒ¨:", err));
    }

    setInterval(updatePlayerList, 1000); // ms
    </script>

    <!-- ë§í¬ ë³µì‚¬ -->
    <script>
    function copySessionLink() {
        const input = document.getElementById("session-link");
        const copyMessage = document.getElementById("copy-message");
        const copyBtn = document.querySelector(".copy-btn");
        
        input.select();
        input.setSelectionRange(0, 99999); // ëª¨ë°”ì¼ ëŒ€ì‘

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                copyMessage.textContent = "âœ… í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!";
                copyMessage.className = "copy-message success";
                copyBtn.innerHTML = '<span class="copy-btn-icon">âœ…</span><span class="copy-btn-text">ë³µì‚¬ë¨</span>';
            } else {
                copyMessage.textContent = "âŒ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                copyMessage.className = "copy-message error";
            }
        } catch (err) {
            copyMessage.textContent = "âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ë³µì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
            copyMessage.className = "copy-message error";
        }

        setTimeout(() => {
            copyMessage.textContent = "";
            copyMessage.className = "copy-message";
            copyBtn.innerHTML = '<span class="copy-btn-icon">ğŸ“‹</span><span class="copy-btn-text">ë³µì‚¬</span>';
        }, 2000);
    }
    </script>
{% endblock %}