<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ë°œë¡  ê²Œì„ - ë°©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .role-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .role-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .evil-role {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        .good-role {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        }
        .player-connected {
            border-left: 4px solid #10b981;
        }
        .player-disconnected {
            border-left: 4px solid #ef4444;
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- ë°© ì •ë³´ í—¤ë” -->
            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-8 border border-white/20">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 id="roomTitle" class="text-3xl font-bold text-white">ë°© ì½”ë“œ: </h1>
                        <p id="hostInfo" class="text-gray-300">í˜¸ìŠ¤íŠ¸: </p>
                        <div id="specialRoles" class="flex gap-4 mt-2"></div>
                    </div>
                    <div class="text-right">
                        <p id="playerCount" class="text-white text-lg">í”Œë ˆì´ì–´: 0/10</p>
                        <button id="startGameBtn" 
                                class="mt-2 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white font-bold py-2 px-6 rounded-lg transition-all duration-300 hidden">
                            ê²Œì„ ì‹œì‘
                        </button>
                        <button id="restartGameBtn" 
                                class="mt-2 bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-700 hover:to-orange-700 text-white font-bold py-2 px-6 rounded-lg transition-all duration-300 hidden">
                            ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°
                        </button>
                        <button id="homeBtn" 
                                class="mt-2 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-bold py-2 px-6 rounded-lg transition-all duration-300">
                            í™ˆìœ¼ë¡œ
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">
                <!-- í”Œë ˆì´ì–´ ëª©ë¡ -->
                <div class="lg:col-span-1">
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <h2 class="text-xl font-bold text-white mb-4">í”Œë ˆì´ì–´ ëª©ë¡</h2>
                        <div id="playerList" class="space-y-3"></div>
                    </div>
                </div>

                <!-- ê²Œì„ ì˜ì—­ -->
                <div class="lg:col-span-2">
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <div id="gameArea">
                            <!-- ëŒ€ê¸° í™”ë©´ -->
                            <div id="lobbyScreen" class="text-center py-12">
                                <h2 class="text-2xl font-bold text-white mb-4">ê²Œì„ ëŒ€ê¸° ì¤‘...</h2>
                                <p class="text-gray-300 mb-6">í˜¸ìŠ¤íŠ¸ê°€ ê²Œì„ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                                <div class="text-gray-400">
                                    <p>ìµœì†Œ 5ëª…ì˜ í”Œë ˆì´ì–´ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
                                    <p id="currentPlayerCount">í˜„ì¬ í”Œë ˆì´ì–´: 0ëª…</p>
                                </div>
                            </div>

                            <!-- ì—­í•  ê³µê°œ í™”ë©´ -->
                            <div id="roleRevealScreen" class="text-center hidden">
                                <h2 class="text-2xl font-bold text-white mb-6">ë‹¹ì‹ ì˜ ì—­í• </h2>
                                <div id="roleCard" class="role-card rounded-2xl p-8 text-white text-center max-w-md mx-auto">
                                    <h3 id="roleName" class="text-3xl font-bold mb-4"></h3>
                                    <div id="roleDescription" class="text-lg"></div>
                                </div>
                                <div id="roleInfo" class="mt-6 text-gray-300"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
    <div id="messageContainer" class="fixed top-4 right-4 z-50"></div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let socket;
        let roomData = null;
        let currentPlayer = null;

        // URLì—ì„œ ë°© ì½”ë“œ ì¶”ì¶œ
        const roomCode = window.location.pathname.split('/')[2];
        const playerName = sessionStorage.getItem('playerName');

        // í”Œë ˆì´ì–´ ì •ë³´ê°€ ì—†ìœ¼ë©´ í™ˆìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        if (!playerName) {
            window.location.href = '/';
        }

        // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMessage(message, type = 'error') {
            const messageContainer = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white px-6 py-3 rounded-lg shadow-lg mb-2 animate-pulse`;
            messageDiv.textContent = message;
            messageContainer.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // ì—­í•  ì •ë³´
        const roleInfo = {
            merlin: {
                name: 'ë©€ë¦°',
                description: 'ëª¨ë“  ì•…ì—­ì„ ì•Œ ìˆ˜ ìˆì§€ë§Œ, ì •ì²´ê°€ ë“¤í‚¤ë©´ ì•ˆ ë©ë‹ˆë‹¤.',
                class: 'good-role',
                info: 'ë‹¹ì‹ ì€ ë©€ë¦°ì…ë‹ˆë‹¤. ëª¨ë“  ì•…ì—­ì„ ì•Œ ìˆ˜ ìˆì§€ë§Œ ëª¨ë“œë ˆë“œëŠ” ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.'
            },
            percival: {
                name: 'í¼ì‹œë°œ',
                description: 'ë©€ë¦°ê³¼ ëª¨ë¥´ê°€ë‚˜ë¥¼ êµ¬ë³„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                class: 'good-role',
                info: 'ë‹¹ì‹ ì€ í¼ì‹œë°œì…ë‹ˆë‹¤. ë©€ë¦°ê³¼ ëª¨ë¥´ê°€ë‚˜ ì¤‘ ëˆ„ê°€ ì§„ì§œ ë©€ë¦°ì¸ì§€ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤.'
            },
            servant: {
                name: 'ì¶©ì‹ ',
                description: 'ì„ ëŸ‰í•œ ì•„ì„œì™•ì˜ ì¶©ì‹ ì…ë‹ˆë‹¤.',
                class: 'good-role',
                info: 'ë‹¹ì‹ ì€ ì¶©ì‹ ì…ë‹ˆë‹¤. íŠ¹ë³„í•œ ëŠ¥ë ¥ì€ ì—†ì§€ë§Œ ì„ ì—­ì˜ ìŠ¹ë¦¬ë¥¼ ìœ„í•´ ë…¸ë ¥í•˜ì„¸ìš”.'
            },
            assassin: {
                name: 'ì•”ì‚´ì',
                description: 'ê²Œì„ ì¢…ë£Œ ì‹œ ë©€ë¦°ì„ ì•”ì‚´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                class: 'evil-role',
                info: 'ë‹¹ì‹ ì€ ì•”ì‚´ìì…ë‹ˆë‹¤. ì„ ì—­ì´ ìŠ¹ë¦¬í•˜ë©´ ë©€ë¦°ì„ ì°¾ì•„ ì•”ì‚´í•  ê¸°íšŒê°€ ìˆìŠµë‹ˆë‹¤.'
            },
            morgana: {
                name: 'ëª¨ë¥´ê°€ë‚˜',
                description: 'í¼ì‹œë°œì—ê²Œ ë©€ë¦°ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.',
                class: 'evil-role',
                info: 'ë‹¹ì‹ ì€ ëª¨ë¥´ê°€ë‚˜ì…ë‹ˆë‹¤. í¼ì‹œë°œì„ í˜¼ë€ì‹œí‚¤ì„¸ìš”.'
            },
            mordred: {
                name: 'ëª¨ë“œë ˆë“œ',
                description: 'ë©€ë¦°ì—ê²Œ ë³´ì´ì§€ ì•ŠëŠ” ì•…ì—­ì…ë‹ˆë‹¤.',
                class: 'evil-role',
                info: 'ë‹¹ì‹ ì€ ëª¨ë“œë ˆë“œì…ë‹ˆë‹¤. ë©€ë¦°ë„ ë‹¹ì‹ ì„ ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
            },
            oberon: {
                name: 'ì˜¤ë² ë¡ ',
                description: 'ë‹¤ë¥¸ ì•…ì—­ì„ ëª¨ë¥´ëŠ” ì•…ì—­ì…ë‹ˆë‹¤.',
                class: 'evil-role',
                info: 'ë‹¹ì‹ ì€ ì˜¤ë² ë¡ ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì•…ì—­ì´ ëˆ„êµ¬ì¸ì§€ ëª¨ë¦…ë‹ˆë‹¤.'
            },
            minion: {
                name: 'ë¯¸ë‹ˆì–¸',
                description: 'ëª¨ë¥´ë“œë ˆë“œì˜ ì¶©ì‹¤í•œ ë¶€í•˜ì…ë‹ˆë‹¤.',
                class: 'evil-role',
                info: 'ë‹¹ì‹ ì€ ë¯¸ë‹ˆì–¸ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì•…ì—­ë“¤ê³¼ í˜‘ë ¥í•˜ì—¬ ìŠ¹ë¦¬í•˜ì„¸ìš”.'
            }
        };

        // Socket.IO ì—°ê²°
        function initSocket() {
            socket = io();

            socket.on('connect', () => {
                console.log('ì„œë²„ì— ì—°ê²°ë¨');
                socket.emit('join-room', { roomCode, playerName });
            });

            socket.on('players-updated', (data) => {
                updatePlayerList(data.players);
            });

            socket.on('game-started', (data) => {
                roomData.gameState = data.gameState;
                const player = data.players.find(p => p.name === playerName);
                if (player) {
                    currentPlayer = player;
                    showRoleReveal();
                }
                updateUI();
            });

            socket.on('game-restarted', (data) => {
                roomData.gameState = data.gameState;
                currentPlayer.role = '';
                showLobby();
                updateUI();
                showMessage('ë¡œë¹„ë¡œ ëŒì•„ê°”ìŠµë‹ˆë‹¤.', 'success');
            });

            socket.on('error', (data) => {
                showMessage(data.message);
            });

            socket.on('disconnect', () => {
                console.log('ì„œë²„ ì—°ê²° ëŠì–´ì§');
            });
        }

        // ë°© ì •ë³´ ë¡œë“œ
        async function loadRoomData() {
            try {
                const response = await fetch(`/api/room/${roomCode}`);
                const data = await response.json();
                
                if (data.error) {
                    showMessage(data.error);
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                    return;
                }

                roomData = data;
                currentPlayer = data.players.find(p => p.name === playerName);
                
                if (!currentPlayer) {
                    showMessage('í”Œë ˆì´ì–´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                    return;
                }

                updateUI();
                
                if (roomData.gameState.phase === 'role_reveal' && currentPlayer.role) {
                    showRoleReveal();
                } else {
                    showLobby();
                }
                
            } catch (error) {
                showMessage('ë°© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            }
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            if (!roomData) return;

            // ë°© ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('roomTitle').textContent = `ë°© ì½”ë“œ: ${roomData.roomCode}`;
            document.getElementById('hostInfo').textContent = `í˜¸ìŠ¤íŠ¸: ${roomData.hostName}`;
            document.getElementById('playerCount').textContent = `í”Œë ˆì´ì–´: ${roomData.players.length}/10`;
            document.getElementById('currentPlayerCount').textContent = `í˜„ì¬ í”Œë ˆì´ì–´: ${roomData.players.length}ëª…`;

            // íŠ¹ìˆ˜ ì—­í•  í‘œì‹œ
            const specialRoles = document.getElementById('specialRoles');
            specialRoles.innerHTML = '';
            if (roomData.includeOberon) {
                specialRoles.innerHTML += '<span class="bg-red-500/20 text-red-300 px-3 py-1 rounded-full text-sm">ì˜¤ë² ë¡  í¬í•¨</span>';
            }
            if (roomData.includeMordred) {
                specialRoles.innerHTML += '<span class="bg-red-500/20 text-red-300 px-3 py-1 rounded-full text-sm">ëª¨ë“œë ˆë“œ í¬í•¨</span>';
            }

            // ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
            const startBtn = document.getElementById('startGameBtn');
            const restartBtn = document.getElementById('restartGameBtn');
            
            if (currentPlayer && currentPlayer.isHost) {
                if (roomData.gameState.phase === 'lobby') {
                    startBtn.classList.remove('hidden');
                    restartBtn.classList.add('hidden');
                } else {
                    startBtn.classList.add('hidden');
                    restartBtn.classList.remove('hidden');
                }
            } else {
                startBtn.classList.add('hidden');
                restartBtn.classList.add('hidden');
            }

            updatePlayerList(roomData.players);
        }

        // í”Œë ˆì´ì–´ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updatePlayerList(players) {
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';

            players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = `flex items-center justify-between bg-white/10 rounded-lg p-3 ${player.connected ? 'player-connected' : 'player-disconnected'}`;
                
                const leftDiv = document.createElement('div');
                leftDiv.className = 'flex items-center';
                
                if (player.isHost) {
                    leftDiv.innerHTML += '<span class="text-yellow-400 mr-2">ğŸ‘‘</span>';
                }
                
                leftDiv.innerHTML += `<span class="text-white font-medium">${player.name}</span>`;
                
                if (player.name === playerName) {
                    leftDiv.innerHTML += '<span class="text-blue-400 ml-2">(ë‚˜)</span>';
                }

                const rightDiv = document.createElement('div');
                if (player.role) {
                    rightDiv.innerHTML = '<span class="text-sm text-gray-300">ì—­í•  ë°°ì •ë¨</span>';
                }
                if (!player.connected) {
                    rightDiv.innerHTML += '<span class="text-sm text-red-400 ml-2">ì—°ê²° ëŠì–´ì§</span>';
                }

                playerDiv.appendChild(leftDiv);
                playerDiv.appendChild(rightDiv);
                playerList.appendChild(playerDiv);
            });

            // roomDataê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
            if (roomData) {
                roomData.players = players;
            }
        }

        // ë¡œë¹„ í™”ë©´ í‘œì‹œ
        function showLobby() {
            document.getElementById('lobbyScreen').classList.remove('hidden');
            document.getElementById('roleRevealScreen').classList.add('hidden');
        }

        // ì—­í•  ê³µê°œ í™”ë©´ í‘œì‹œ
        function showRoleReveal() {
            document.getElementById('lobbyScreen').classList.add('hidden');
            document.getElementById('roleRevealScreen').classList.remove('hidden');

            if (currentPlayer && currentPlayer.role) {
                const role = roleInfo[currentPlayer.role];
                if (role) {
                    document.getElementById('roleName').textContent = role.name;
                    document.getElementById('roleDescription').textContent = role.description;
                    document.getElementById('roleInfo').textContent = role.info;
                    
                    const roleCard = document.getElementById('roleCard');
                    roleCard.className = `role-card rounded-2xl p-8 text-white text-center max-w-md mx-auto ${role.class}`;
                }
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('startGameBtn').addEventListener('click', () => {
            socket.emit('start-game', { roomCode, playerName });
        });

        document.getElementById('restartGameBtn').addEventListener('click', () => {
            if (confirm('ì •ë§ë¡œ ë¡œë¹„ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                socket.emit('restart-game', { roomCode, playerName });
            }
        });

        document.getElementById('homeBtn').addEventListener('click', () => {
            if (confirm('í™ˆìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.location.href = '/';
            }
        });

        // ì´ˆê¸°í™”
        loadRoomData().then(() => {
            initSocket();
        });
    </script>
</body>
</html>